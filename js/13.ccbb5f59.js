(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{531:function(n,t){n.exports="\x3c!--\ntitle: Gitlab\nsort: 2\n--\x3e\n\nCentOS7 å®‰è£…ç»´æŠ¤ Gitlab\n\n##  å®˜æ–¹å®‰è£…\n\nä¸‹é¢æ˜¯å®˜ç½‘å¤åˆ¶è¿‡æ¥çš„å®˜æ–¹å®‰è£…æ–¹æ³•ï¼Œæœ€ç®€å•çš„å®‰è£…ï¼Œåœ¨æˆ‘å¤§å¤©æœï¼Œåªèƒ½æœ›å¤©å…´å¹ï¼Œä½ å¯ç¿»å¢™å®‰è£…æˆ–è€…ç•¥è¿‡è¿™é‡Œï¼Œçœ‹ä¸‹é¢çš„ã€‚\n\n1. å®‰è£…å¹¶é…ç½®å¿…è¦çš„ä¾èµ–é¡¹\n\nIf you install Postfix to send email please select 'Internet Site' during setup. Instead of using Postfix you can also use Sendmail or configure a custom SMTP server and configure it as an SMTP server.\n\nOn Centos 6 and 7, the commands below will also open HTTP and SSH access in the system firewall.\n\n```\nsudo yum install curl openssh-server openssh-clients postfix cronie\nsudo service postfix start\nsudo chkconfig postfix on\nsudo lokkit -s http -s ssh\n```\n\n2. æ·»åŠ gitlabæœåŠ¡å™¨åŒ…å’Œå®‰è£…åŒ…\n\n```\ncurl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash\nsudo yum install gitlab-ce\n```\n\nIf you are not comfortable installing the repository through a piped script, you can find the entire script here and select and download the package manually and install using\n[gitlab/gitlab-ce](https://packages.gitlab.com/gitlab/gitlab-ce)\n\n```bash\ncurl -LJO https://packages.gitlab.com/gitlab/gitlab-ce/packages/el/6/gitlab-ce-XXX.rpm/download\ncurl -LJO https://packages.gitlab.com/gitlab/gitlab-ce/packages/el/7/gitlab-ce-10.2.2-ce.0.el7.x86_64.rpm/download\nrpm -i gitlab-ce-XXX.rpm\n```\n\n3. é…ç½®å¹¶å¯åŠ¨GitLab\n\n```\nsudo gitlab-ctl reconfigure\n```\n\n4. æµè§ˆå™¨æ‰“å¼€å¹¶ç™»å½•\n\nOn your first visit, you'll be redirected to a password reset screen to provide the password for the initial administrator account. Enter your desired password and you'll be redirected back to the login screen.\n\nThe default account's username is root. Provide the password you created earlier and login. After login you can change the username if you wish.\n\n\n\n## ç¬¬ä¸‰æ–¹é•œåƒå®‰è£…\n\n- [Gitlab Community Edition é•œåƒä½¿ç”¨å¸®åŠ©](https://mirror.tuna.tsinghua.edu.cn/help/gitlab-ce/)\n- [åœ¨é˜¿é‡Œäº‘ä¸Šé€šè¿‡Omnibusä¸€é”®å®‰è£…åŒ…å®‰è£…Gitlab](https://github.com/hehongwei44/my-blog/issues/19)\n\n### ç¼–è¾‘æº\n\næ–°å»º /etc/yum.repos.d/gitlab-ce.repoï¼Œå†…å®¹ä¸º\n\n[ä½¿ç”¨æ¸…åå¤§å­¦ TUNA é•œåƒæº](https://mirror.tuna.tsinghua.edu.cn/help/gitlab-ce/) æ‰“å¼€ç½‘å€å°†å†…å®¹å¤åˆ¶åˆ°`gitlab-ce.repo`æ–‡ä»¶ä¸­ï¼Œç¼–è¾‘è·¯å¾„`vim /etc/yum.repos.d/gitlab-ce.repo`\n\n```bash\n[gitlab-ce]\nname=gitlab-ce\nbaseurl=http://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el6\nrepo_gpgcheck=0\ngpgcheck=0\nenabled=1\ngpgkey=https://packages.gitlab.com/gpg.key\n```\n\n### æ›´æ–°æœ¬åœ°YUMç¼“å­˜\n\n```bash \nsudo yum makecache\n```\n\n### å®‰è£…ç¤¾åŒºç‰ˆ\n\n```bash\nsudo yum install gitlab-ce #(è‡ªåŠ¨å®‰è£…æœ€æ–°ç‰ˆ)\nsudo yum install gitlab-ce-8.15.2-ce.0.el6 #(å®‰è£…æŒ‡å®šç‰ˆæœ¬)\n```\n\n### æ›´æ”¹é…ç½®\n\n```bash\nvim /etc/gitlab/gitlab.rb\n# æ‰¾åˆ° external_url 'http://000.00.00.00:8081'\n# ä¿®æ”¹æˆä½ çš„åœ°å€\n```\n\n### é…ç½®å¹¶å¯åŠ¨GitLab\n\n```bash\n# æ‰“å¼€`/etc/gitlab/gitlab.rb`,\n# å°†`external_url = 'http://git.example.com'`ä¿®æ”¹ä¸ºè‡ªå·±çš„IPåœ°å€ï¼š`http://xxx.xx.xxx.xx`ï¼Œ\n# ç„¶åæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå¯¹GitLabè¿›è¡Œç¼–è¯‘ã€‚\nsudo gitlab-ctl reconfigure\n# æ¸…é™¤ç¼“å­˜\nsudo gitlab-rake cache:clear RAILS_ENV=production\n```\n\n### ç™»å½•GitLab\n\n```\nUsername: root \nPassword: 5iveL!fe\n```\n\n## å¸è½½\n\n```bash\nsudo gitlab-ctl uninstall\n```\n\n## è¿ç»´ \n\n```bash\n# ä¿®æ”¹é»˜è®¤çš„é…ç½®æ–‡ä»¶\nsudo vim /etc/gitlab/gitlab.rb\n\n# æŸ¥çœ‹ç‰ˆæœ¬\nsudo cat /opt/gitlab/embedded/service/gitlab-rails/VERSION\n# echo \"vm.overcommit_memory=1\" >> /etc/sysctl.conf\n# sysctl -p\n# echo never > /sys/kernel/mm/transparent_hugepage/enabled\n\n# æ£€æŸ¥gitlab\ngitlab-rake gitlab:check SANITIZE=true --trace\ngitlab-rake gitlab:check\ngitlab-rake gitlab:check SANITIZE=true\n# æŸ¥çœ‹æ—¥å¿—\ngitlab-ctl tail\n# æ•°æ®åº“å…³ç³»å‡çº§\ngitlab-rake db:migrate\n# æ¸…ç†ç¼“å­˜\ngitlab-rake cache:clear\n\n# æ›´æ–°gitlabåŒ…\nyum update gitlab-ce\n\n# å‡çº§gitlab\nyum install gitlab-ce\n\n# å‡çº§æ•°æ®å‘½ä»¤\ngitlab-ctl pg-upgrade\n```\n\n### æœåŠ¡ç®¡ç†\n\n```bash \ngitlab-ctl start # å¯åŠ¨æ‰€æœ‰ gitlab ç»„ä»¶ï¼š\ngitlab-ctl stop  # åœæ­¢æ‰€æœ‰ gitlab ç»„ä»¶ï¼š\ngitlab-ctl stop postgresql # åœæ­¢æ‰€æœ‰ gitlab postgresql ç»„ä»¶ï¼š\n# åœæ­¢ç›¸å…³æ•°æ®è¿æ¥æœåŠ¡\ngitlab-ctl stop unicorn\ngitlab-ctl stop sidekiq\ngitlab-ctl restart # é‡å¯æ‰€æœ‰ gitlab ç»„ä»¶ï¼š\ngitlab-ctl restart gitlab-workhorse # é‡å¯æ‰€æœ‰ gitlab gitlab-workhorse ç»„ä»¶ï¼š\ngitlab-ctl status # æŸ¥çœ‹æœåŠ¡çŠ¶æ€\ngitlab-ctl reconfigure # ç”Ÿæˆé…ç½®å¯åŠ¨æœåŠ¡\n```\n\n### æ—¥å¿—æŸ¥çœ‹\n\n```bash\nsudo gitlab-ctl tail # æŸ¥çœ‹æ—¥å¿—\nsudo gitlab-ctl tail redis # æ£€æŸ¥redisçš„æ—¥å¿—\nsudo gitlab-ctl tail postgresql       # æ£€æŸ¥postgresqlçš„æ—¥å¿—\nsudo gitlab-ctl tail gitlab-workhorse # æ£€æŸ¥gitlab-workhorseçš„æ—¥å¿—\nsudo gitlab-ctl tail logrotate # æ£€æŸ¥logrotateçš„æ—¥å¿—\nsudo gitlab-ctl tail nginx    # æ£€æŸ¥nginxçš„æ—¥å¿—\nsudo gitlab-ctl tail sidekiq  # æ£€æŸ¥sidekiqçš„æ—¥å¿—\nsudo gitlab-ctl tail unicorn  # æ£€æŸ¥unicornçš„æ—¥å¿—\n```\n\n### é‡ç½®ç®¡ç†å‘˜å¯†ç \n\nGitlabç®¡ç†å‘˜å¯†ç å¿˜è®°ï¼Œæ€ä¹ˆé‡ç½®å¯†ç ï¼ŒGitlab ä¿®æ”¹rootç”¨æˆ·å¯†ç ï¼Œ[How to reset your root password](http://docs.gitlab.com/ce/security/reset_root_password.html)ã€‚\n\nä½¿ç”¨railså·¥å…·æ‰“å¼€ç»ˆç«¯\n\n```bash\nsudo gitlab-rails console production\n```\n\næŸ¥è¯¢ç”¨æˆ·çš„emailï¼Œç”¨æˆ·åï¼Œå¯†ç ç­‰ä¿¡æ¯ï¼Œid:1 è¡¨ç¤ºrootè´¦å·\n\n```bash\nuser = User.where(id: 1).first\n```\n\né‡æ–°è®¾ç½®å¯†ç \n\n```bash\nuser.password = 'æ–°å¯†ç '\nuser.password_confirmation = 'æ–°å¯†ç 'ã€€\n```\n\nä¿å­˜å¯†ç \n\n```bash\nuser.save!\n```\n\nå®Œæ•´çš„æ“ä½œrubyè„šæœ¬\n\n```bash\nuser = User.where(id: 1).first\nuser.password = 'æ–°å¯†ç '\nuser.password_confirmation = 'æ–°å¯†ç '\nuser.save!\n```\n\n## å¤‡ä»½æ¢å¤\n\nä½¿ç”¨Gitlabä¸€é”®å®‰è£…åŒ…å®‰è£…Gitlabéå¸¸ç®€å•, åŒæ ·çš„å¤‡ä»½æ¢å¤ä¸è¿ç§»ä¹Ÿéå¸¸ç®€å•,ç”¨ä¸€æ¡å‘½ä»¤å³å¯åˆ›å»ºå®Œæ•´çš„Gitlabå¤‡ä»½:\n\n### ä¿®æ”¹å¤‡ä»½æ–‡ä»¶é»˜è®¤ç›®å½•\n\nä¿®æ”¹`/etc/gitlab/gitlab.rb`æ¥ä¿®æ”¹é»˜è®¤å­˜æ”¾å¤‡ä»½æ–‡ä»¶çš„ç›®å½•:\n\n```bash\ngitlab_rails['backup_path'] = '/mnt/backups'  \n```\n\n### åˆ›å»ºå¤‡ä»½\n\n```bash\ngitlab-rake gitlab:backup:create\n```\n\nä»¥ä¸Šå‘½ä»¤å°†åœ¨/var/opt/gitlab/backupsç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåç§°ç±»ä¼¼ä¸ºxxxxxxxx_gitlab_backup.tarçš„å‹ç¼©åŒ…, è¿™ä¸ªå‹ç¼©åŒ…å°±æ˜¯Gitlabæ•´ä¸ªçš„å®Œæ•´éƒ¨åˆ†, å…¶ä¸­å¼€å¤´çš„xxxxxxæ˜¯å¤‡ä»½åˆ›å»ºçš„æ—¶é—´æˆ³ã€‚\n\nä¿®æ”¹åä½¿ç”¨gitlab-ctl reconfigureå‘½ä»¤é‡è½½é…ç½®æ–‡ä»¶ã€‚\n\n### å¼€å§‹å¤‡ä»½\n\nè¿™é‡Œæ”¾ä½ çš„å¤‡ä»½æ–‡ä»¶æ–‡ä»¶å¤¹ï¼Œå’Œä»“åº“æºæ–‡ä»¶ã€‚\n\n```bash\n/var/opt/gitlab/backups                   # å¤‡ä»½æ–‡ä»¶æ–‡ä»¶å¤¹\n/var/opt/gitlab/git-data/repositories     # gitä»“åº“æºæ–‡ä»¶\n```\n\n### è‡ªåŠ¨å¤‡ä»½\n\né€šè¿‡crontabä½¿ç”¨å¤‡ä»½å‘½ä»¤å®ç°è‡ªåŠ¨å¤‡ä»½\n\n```bash\ncrontab -e\n# æ¯å¤©2ç‚¹å¤‡ä»½gitlabæ•°æ®\n0 2 * * * /usr/bin/gitlab-rake gitlab:backup:create\n0 2 * * * /opt/gitlab/bin/gitlab-rake gitlab:backup:create\n```\n\nä¸Šé¢ä¸¤è¡Œä¿å­˜ä¹‹åï¼Œé‡æ–°è½½å…¥é…ç½®\n\n```bash\nservice crond reload\n# or\nsystemctl reload crond.service\n```\n\n### å¤‡ä»½ä¿ç•™ä¸ƒå¤©\n\nè®¾ç½®åªä¿å­˜æœ€è¿‘7å¤©çš„å¤‡ä»½ï¼Œç¼–è¾‘ /etc/gitlab/gitlab.rb é…ç½®æ–‡ä»¶ï¼Œæ‰¾åˆ°å¦‚ä¸‹ä»£ç ï¼Œåˆ é™¤æ³¨é‡Š `#` ä¿å­˜\n\n```bash\n# /etc/gitlab/gitlab.rb é…ç½®æ–‡ä»¶ ä¿®æ”¹ä¸‹é¢è¿™ä¸€è¡Œ\ngitlab_rails['backup_keep_time'] = 604800  \n```\n\né‡æ–°åŠ è½½gitlabé…ç½®æ–‡ä»¶\n\n```bash\nsudo gitlab-ctl reconfigure  \n```\n\n\n### å¼€å§‹æ¢å¤\n\nè¿ç§»å¦‚åŒå¤‡ä»½ä¸æ¢å¤çš„æ­¥éª¤ä¸€æ ·, åªéœ€è¦å°†è€æœåŠ¡å™¨ `/var/opt/gitlab/backups` ç›®å½•ä¸‹çš„å¤‡ä»½æ–‡ä»¶æ‹·è´åˆ°æ–°æœåŠ¡å™¨ä¸Šçš„ `/var/opt/gitlab/backups` å³å¯(å¦‚æœä½ æ²¡ä¿®æ”¹è¿‡é»˜è®¤å¤‡ä»½ç›®å½•çš„è¯)ã€‚ ç„¶åæ‰§è¡Œæ¢å¤å‘½ä»¤ã€‚\nå¦‚æœä¿®æ”¹äº†ï¼Œé¦–å…ˆè¿›å…¥å¤‡ä»½ gitlab çš„ç›®å½•ï¼Œè¿™ä¸ªç›®å½•æ˜¯é…ç½®æ–‡ä»¶ä¸­çš„ `gitlab_rails['backup_path']` ï¼Œé»˜è®¤ä¸º `/var/opt/gitlab/backups` ã€‚\n\nç„¶ååœæ­¢ unicorn å’Œ sidekiq ï¼Œä¿è¯æ•°æ®åº“æ²¡æœ‰æ–°çš„è¿æ¥ï¼Œä¸ä¼šæœ‰å†™æ•°æ®æƒ…å†µã€‚\n\n```bash\n# åœæ­¢ç›¸å…³æ•°æ®è¿æ¥æœåŠ¡\ngitlab-ctl stop unicorn\n# ok: down: unicorn: 0s, normally up\ngitlab-ctl stop sidekiq\n# ok: down: sidekiq: 0s, normally up\n\n# ä»xxxxxç¼–å·å¤‡ä»½ä¸­æ¢å¤\n# ç„¶åæ¢å¤æ•°æ®ï¼Œ1406691018ä¸ºå¤‡ä»½æ–‡ä»¶çš„æ—¶é—´æˆ³\ngitlab-rake gitlab:backup:restore BACKUP=1406691018\n\n# æ–°ç‰ˆæœ¬ 1483533591_2017_01_04_gitlab_backup.tar\ngitlab-rake gitlab:backup:restore BACKUP=1483533591_2017_01_04_gitlab_backup.tar\n\n# å¯åŠ¨Gitlab\nsudo gitlab-ctl start  \n```\n\nåˆ¤æ–­æ˜¯æ‰§è¡Œå®é™…æ“ä½œçš„gitlabç›¸å…³ç”¨æˆ·ï¼šgitï¼Œæ²¡æœ‰å¾—åˆ°è¶³å¤Ÿçš„æƒé™ã€‚ä¾æ¬¡æ‰§è¡Œå‘½ä»¤ï¼š\n\n```bash\n# æ¢å¤è¿‡ç¨‹ä¸­æ²¡æœ‰æƒé™\nmkdir /var/opt/gitlab/backups\nchown git /var/opt/gitlab/backups\nchmod 700 /var/opt/gitlab/backups\n\n# æ¢å¤æˆåŠŸé¡µé¢æŠ¥æ²¡æœ‰æƒé™çš„é”™è¯¯\nsudo chown -R git:git /var/opt/gitlab/git-data/repositories\nsudo chmod -R ug+rwX,o-rwx /var/opt/gitlab/git-data/repositories\nsudo chmod -R ug-s /var/opt/gitlab/git-data/repositories\nsudo find /var/opt/gitlab/git-data/repositories -type d -print0 | sudo xargs -0 chmod g+s\n```\n\nå¦‚æœå¤‡ä»½æ–‡ä»¶æŠ¥æ²¡æœ‰æƒé™ï¼Œé€šè¿‡`ls -al`æŸ¥çœ‹æƒé™æ˜¯ä¸æ˜¯`git`ï¼Œè€Œä¸æ˜¯`root`ï¼Œé€šè¿‡ä¸‹é¢æ–¹å¼ç»™`git`ç”¨æˆ·æƒé™\n\n```bash\nsudo chown -R git:git 1483533591_2017_01_04_gitlab_backup.tar\n```\n\n## ä¸€äº›å¸¸è§„ç›®å½•\n\n```bash\n# é…ç½®ç›®å½•\n/etc/gitlab/gitlab.rb\n# ç”Ÿæˆå¥½çš„nginxé…ç½®\n/var/opt/gitlab/nginx/conf/gitlab-http.conf\n# å¤‡ä»½ç›®å½•\n/var/opt/gitlab/backups\n```\n\n## ä½¿ç”¨HTTPS\n\nç›´æ¥å°†nginxé…ç½®å¤åˆ¶åˆ°ä½ è‡ªå·±çš„nginxé…ç½®ä¸­ï¼Œåœæ‰gitlabçš„nginx\n\n```bash\ncp /var/opt/gitlab/nginx/conf/gitlab-http.conf /usr/local/nginx/conf/vhost/\n```\n\nå°†ä½ çš„SSLè¯ä¹¦é…ç½®å¤åˆ¶è¿›å»\n\n```nginx\nserver {\n  listen 443 ssl;\n  server_name  g.doman.cn;\n  ssl_certificate /etc/letsencrypt/live/*****/certificate.crt;\n  ssl_certificate_key /etc/letsencrypt/live/*****/private.key;\n  # .....\n}\n```\n\nç¼–è¾‘`vi /usr/local/nginx/conf/nginx.conf`ä½ çš„nginxé…ç½®ï¼Œå¼•ç”¨ä½ å¤åˆ¶è¿‡æ¥çš„é…ç½®ã€‚\n\n```nginx\nhttp {\n  # .....\n  include vhost/gitlab-http.conf;\n}\n```\n\nåŒæ—¶è¦æŠŠ`/var/opt/gitlab/nginx/conf/nginx.conf`ä¸­çš„ä¸€äº›å˜é‡å¤åˆ¶åˆ°è‡ªå·±çš„nginxé…ç½®ä¸­`nginx.conf`\n\n```nginx\nhttp {\n  # .....\n  log_format gitlab_access '$remote_addr - $remote_user [$time_local] \"$request_method $filtered_request_uri $server_protocol\" $status $body_bytes_sent \"$filtered_http_referer\" \"$http_user_agent\"';\n  log_format gitlab_mattermost_access '$remote_addr - $remote_user [$time_local] \"$request_method $filtered_request_uri $server_protocol\" $status $body_bytes_sent \"$filtered_http_referer\" \"$http_user_agent\"';\n\n  proxy_cache_path proxy_cache keys_zone=gitlab:10m max_size=1g levels=1:2;\n  proxy_cache gitlab;\n  map $http_upgrade $connection_upgrade {\n      default upgrade;\n      ''      close;\n  }\n\n  # Remove private_token from the request URI\n  # In:  /foo?private_token=unfiltered&authenticity_token=unfiltered&rss_token=unfiltered&...\n  # Out: /foo?private_token=[FILTERED]&authenticity_token=unfiltered&rss_token=unfiltered&...\n  map $request_uri $temp_request_uri_1 {\n    default $request_uri;\n    ~(?i)^(?<start>.*)(?<temp>[\\?&]private[\\-_]token)=[^&]*(?<rest>.*)$ \"$start$temp=[FILTERED]$rest\";\n  }\n  # Remove authenticity_token from the request URI\n  # In:  /foo?private_token=[FILTERED]&authenticity_token=unfiltered&rss_token=unfiltered&...\n  # Out: /foo?private_token=[FILTERED]&authenticity_token=[FILTERED]&rss_token=unfiltered&...\n  map $temp_request_uri_1 $temp_request_uri_2 {\n    default $temp_request_uri_1;\n    ~(?i)^(?<start>.*)(?<temp>[\\?&]authenticity[\\-_]token)=[^&]*(?<rest>.*)$ \"$start$temp=[FILTERED]$rest\";\n  }\n  # Remove rss_token from the request URI\n  # In:  /foo?private_token=[FILTERED]&authenticity_token=[FILTERED]&rss_token=unfiltered&...\n  # Out: /foo?private_token=[FILTERED]&authenticity_token=[FILTERED]&rss_token=[FILTERED]&...\n  map $temp_request_uri_2 $filtered_request_uri {\n    default $temp_request_uri_2;\n    ~(?i)^(?<start>.*)(?<temp>[\\?&]rss[\\-_]token)=[^&]*(?<rest>.*)$ \"$start$temp=[FILTERED]$rest\";\n  }\n  # A version of the referer without the query string\n  map $http_referer $filtered_http_referer {\n    default $http_referer;\n    ~^(?<temp>.*)\\? $temp;\n  }\n}\n```\n\n\n## æš´åŠ›å‡çº§\n\næš´åŠ›å‡çº§å‰å…ˆå¤‡ä»½ï¼Œç„¶ååœæ­¢æ‰€æœ‰æœåŠ¡è¿è¡Œï¼Œè®°å¾—å¤‡ä»½çš„è‰¯å¥½ä¹ æƒ¯\n\n```bash\ngitlab-ctl stop  # åœæ­¢æ‰€æœ‰ gitlab ç»„ä»¶ï¼š\n# æ›´æ–°gitlabåŒ…\nyum update gitlab-ce\n```\n\nç›´æ¥ç¼–è¾‘æº /etc/yum.repos.d/gitlab-ce.repoï¼Œå®‰è£… GitLab ç¤¾åŒºç‰ˆ\n\n```bash\nyum list gitlab-ce # æŸ¥çœ‹ç‰ˆæœ¬\nsudo yum install gitlab-ce #(è‡ªåŠ¨å®‰è£…æœ€æ–°ç‰ˆ)\nsudo yum install gitlab-ce-8.15.2-ce.0.el6 #(å®‰è£…æŒ‡å®šç‰ˆæœ¬)\n```\n\nå®‰è£…å®Œæˆè®°å¾—å°†æ‰€æœ‰æœåŠ¡å¯èµ·æ¥å“¦\n\n```bash\ngitlab-ctl start # å¯åŠ¨æ‰€æœ‰æ•°æ®åº“\n# postgresql æ•°æ®åº“å¦‚æœå¯åŠ¨ä¸äº†ï¼Œé€šè¿‡é‡å¯å¯åŠ¨\ngitlab-ctl restart postgresql\n```\n\nå®‰è£…è¿‡å¦‚æœæŠ¥é”™ï¼ŒæŸ¥çœ‹æç¤ºæ ¹æ®æç¤ºæ“ä½œï¼Œç‰ˆæœ¬è·¨åº¦å¤ªå¤§ä¼šæŠ¥é”™å“¦ã€‚\n\n```\ngitlab preinstall: Automatically backing up only the GitLab SQL database (excluding everything else!)\nDumping database ...\nDumping PostgreSQL database gitlabhq_production ... pg_dump: [archiver (db)] connection to database \"gitlabhq_production\" failed: could not connect to server: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•\n    Is the server running locally and accepting\n    connections on Unix domain socket \"/var/opt/gitlab/postgresql/.s.PGSQL.5432\"?\nBackup failed\n[FAILED]\ngitlab preinstall:\ngitlab preinstall: Backup failed! If you want to skip this backup, run the following command and\ngitlab preinstall: try again:\ngitlab preinstall:\ngitlab preinstall:   sudo touch /etc/gitlab/skip-auto-migrations\ngitlab preinstall:\nerror: %pre(gitlab-ce-8.15.2-ce.0.el6.x86_64) scriptlet failed, exit status 1\nError in PREIN scriptlet in rpm package gitlab-ce-8.15.2-ce.0.el6.x86_64\nerror:   install: %pre scriptlet failed (2), skipping gitlab-ce-8.15.2-ce.0.el6\ngitlab-ce-8.11.5-ce.0.el6.x86_64 was supposed to be removed but is not!\n  Verifying  : gitlab-ce-8.11.5-ce.0.el6.x86_64                                                                                                                                                             1/2\n  Verifying  : gitlab-ce-8.15.2-ce.0.el6.x86_64                                                                                                                                                             2/2\n\nFailed:\n  gitlab-ce.x86_64 0:8.11.5-ce.0.el6\n```\n\nçœ‹ä¸Šé¢ä¸€å †é”™è¯¯ï¼Œç¬é—´å°±æ‡µé€¼äº†ï¼Œçœ‹åˆ°ä¸€æ¡æ•‘æ˜Ÿå‘½ä»¤è®©æˆ‘å°è¯•è¿è¡Œ `sudo touch /etc/gitlab/skip-auto-migrations` äºæ˜¯æˆ‘äºŒé€¼çš„é‡æ–°`yum install gitlab-ce`è¿è¡Œäº†ï¼Œç»“æœçœŸçš„å®‰è£…æˆåŠŸäº†ï¼ŒğŸ˜„ã€‚\n\n```\n...\ngitlab: Thank you for installing GitLab!\ngitlab: To configure and start GitLab, RUN THE FOLLOWING COMMAND:\n\nsudo gitlab-ctl reconfigure\n\ngitlab: GitLab should be reachable at http://114.55.148.71:8081\ngitlab: Otherwise configure GitLab for your system by editing /etc/gitlab/gitlab.rb file\ngitlab: And running reconfigure again.\ngitlab:\ngitlab: For a comprehensive list of configuration options please see the Omnibus GitLab readme\ngitlab: https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md\ngitlab:\n\ngitlab: GitLab now ships with a newer version of PostgreSQL (9.6.1), and will be used\ngitlab: as the default in the next major relase. To upgrade, RUN THE FOLLOWING COMMANDS:\n\nsudo gitlab-ctl pg-upgrade\n\ngitlab: For more details, please see:\ngitlab: https://docs.gitlab.com/omnibus/settings/database.html#upgrade-packaged-postgresql-server\ngitlab:\n  æ¸…ç†       : gitlab-ce-8.11.5-ce.0.el6.x86_64                                                                                                                                                             2/2\nFound /etc/gitlab/skip-auto-migrations, exiting...\n  Verifying  : gitlab-ce-8.15.2-ce.0.el6.x86_64                                                                                                                                                             1/2\n  Verifying  : gitlab-ce-8.11.5-ce.0.el6.x86_64                                                                                                                                                             2/2\n\næ›´æ–°å®Œæ¯•:\n  gitlab-ce.x86_64 0:8.15.2-ce.0.el6\n\nå®Œæ¯•ï¼\n```\n\né‡å¯é…ç½®ï¼Œå¯ä»¥è§£å†³å¤§éƒ¨åˆ†`502`é”™è¯¯ã€‚\n\n```bash\ngitlab-ctl reconfigure\n```\n\n## é”™è¯¯å¤„ç†\n\n### è§£å†³80ç«¯å£è¢«å ç”¨\n\nnginxé…ç½®è§£å†³ `80` ç«¯å£è¢«å ç”¨\n\n```nginx\nupstream gitlab {\n     server 114.55.111.111:8081 ;\n}\nserver {\n  # ä¾¦å¬çš„80ç«¯å£\n  listen       80;\n  server_name  git.diggg.cn;\n  location / {\n    proxy_pass   http://gitlab;    #åœ¨è¿™é‡Œè®¾ç½®ä¸€ä¸ªä»£ç†ï¼Œå’Œupstreamçš„åå­—ä¸€æ ·\n    #ä»¥ä¸‹æ˜¯ä¸€äº›åå‘ä»£ç†çš„é…ç½®å¯åˆ é™¤\n    proxy_redirect             off;\n    #åç«¯çš„WebæœåŠ¡å™¨å¯ä»¥é€šè¿‡X-Forwarded-Forè·å–ç”¨æˆ·çœŸå®IP\n    proxy_set_header           Host $host;\n    proxy_set_header           X-Real-IP $remote_addr;\n    proxy_set_header           X-Forwarded-For $proxy_add_x_forwarded_for;\n    client_max_body_size       10m; #å…è®¸å®¢æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å•æ–‡ä»¶å­—èŠ‚æ•°\n    client_body_buffer_size    128k; #ç¼“å†²åŒºä»£ç†ç¼“å†²ç”¨æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å­—èŠ‚æ•°\n    proxy_connect_timeout      300; #nginxè·Ÿåç«¯æœåŠ¡å™¨è¿æ¥è¶…æ—¶æ—¶é—´(ä»£ç†è¿æ¥è¶…æ—¶)\n    proxy_send_timeout         300; #åç«¯æœåŠ¡å™¨æ•°æ®å›ä¼ æ—¶é—´(ä»£ç†å‘é€è¶…æ—¶)\n    proxy_read_timeout         300; #è¿æ¥æˆåŠŸåï¼Œåç«¯æœåŠ¡å™¨å“åº”æ—¶é—´(ä»£ç†æ¥æ”¶è¶…æ—¶)\n    proxy_buffer_size          4k; #è®¾ç½®ä»£ç†æœåŠ¡å™¨ï¼ˆnginxï¼‰ä¿å­˜ç”¨æˆ·å¤´ä¿¡æ¯çš„ç¼“å†²åŒºå¤§å°\n    proxy_buffers              4 32k; #proxy_buffersç¼“å†²åŒºï¼Œç½‘é¡µå¹³å‡åœ¨32kä»¥ä¸‹çš„è¯ï¼Œè¿™æ ·è®¾ç½®\n    proxy_busy_buffers_size    64k; #é«˜è´Ÿè·ä¸‹ç¼“å†²å¤§å°ï¼ˆproxy_buffers*2ï¼‰\n    proxy_temp_file_write_size 64k; #è®¾å®šç¼“å­˜æ–‡ä»¶å¤¹å¤§å°ï¼Œå¤§äºè¿™ä¸ªå€¼ï¼Œå°†ä»upstreamæœåŠ¡å™¨ä¼ \n  }\n}\n```\n\nnginxé…ç½®æ£€æŸ¥å’Œç«‹å³ç”Ÿæ•ˆ\n\n```bash\n# æ£€æŸ¥é…ç½®\n/usr/local/nginx/sbin/nginx -tc conf/nginx.conf\n# nginx é‡æ–°åŠ è½½é…ç½®\n/usr/local/nginx/sbin/nginx -s reload\n```\n### å¤´åƒæ— æ³•æ­£å¸¸æ˜¾ç¤º\n\nåŸå› ï¼šgravatarè¢«å¢™\nè§£å†³åŠæ³•ï¼š\nç¼–è¾‘ /etc/gitlab/gitlab.rbï¼Œå°†\n\n```bash\n# gitlab_rails['gravatar_plain_url'] = 'http://gravatar.duoshuo.com/avatar/%{hash}?s=%{size}&d=identicon'\n```\n\nä¿®æ”¹ä¸ºï¼š\n\n```\ngitlab_rails['gravatar_plain_url'] = 'http://gravatar.duoshuo.com/avatar/%{hash}?s=%{size}&d=identicon'\n```\n\nç„¶ååœ¨å‘½ä»¤è¡Œæ‰§è¡Œï¼š\n\n```bash\nsudo gitlab-ctl reconfigure \nsudo gitlab-rake cache:clear RAILS_ENV=production\n```\n\n### internal API unreachable\n\nè¿™ä¸ªé”™è¯¯æ˜¯ä¸€ä¸ªè‡ªå·±åˆ¶é€ çš„å‘ï¼Œæˆ‘å…‹éš†å’Œæäº¤éƒ½æ²¡æœ‰åŠæ³•æï¼Œä½†æ˜¯ç½‘ç«™èƒ½æ­£å¸¸è¿è¡Œï¼Œå°è¯•äº†éå¸¸å¤šçš„æ–¹æ³•ï¼Œæœ€ç»ˆæˆ‘çš„é—®é¢˜æ˜¯`22`ç«¯å£æ²¡æœ‰éšå°„å‡ºå»ï¼Œå¥½å°´å°¬ã€‚\n\n```bash\nGitLab: Failed to authorize your Git request: internal API unreachable\n```\n\nè§£å†³åŠæ³•ï¼šhttps://gitlab.com/gitlab-org/gitlab-ce/issues/33702  \né€šè¿‡é˜²ç«å¢™è§„åˆ™ 127.0.0.1  \n\n### proxy_temp ç›®å½•æ²¡æœ‰æƒé™\n\n```bash\n[crit] 14788#0: *215 open() \"/usr/local/nginx/proxy_temp/5/01/0000000015\" failed (13: Permission denied) while reading upstream\n```\n\nä»¥ä¸‹æ–¹å¼è§£å†³\n\n```bash\nchown -R root:root /usr/local/nginx/proxy_temp\n# ç¼–è¾‘ nginx.conf\nsudo vi /usr/local/nginx/conf/nginx.conf\n# åœ¨ç¬¬ä¸€è¡Œæ·»åŠ \nuser root;\n```\n\n### å…¶å®ƒé”™è¯¯\n\n```bash\nError executing action `run` on resource 'bash[migrate gitlab-rails database]'\n```\n\nä¸Šé¢é”™è¯¯æ˜¯æ•°æ®åº“æ²¡æœ‰å¯åŠ¨ï¼Œæˆ‘ä¸çŸ¥é“å¦‚ä½•å¯åŠ¨ï¼Œæˆ‘é‡å¯äº†æœåŠ¡å™¨ï¼Œç„¶åå¥½çƒäº†ã€‚ğŸ˜† \nhttps://gitlab.com/gitlab-org/gitlab-ce/issues/2052#note_1667899\n\n```bash\nNameError: uninitialized constant Devise::Async\n```\n\n\n```\nProcessing by RootController#index as HTML\nCompleted 401 Unauthorized in 17ms (ActiveRecord: 2.7ms)\n```\n\n\n```\n/var/log/gitlab/nginx/gitlab_access.log <==\n114.55.148.71 - - [04/Jan/2017:17:20:24 +0800] \"GET /favicon.ico HTTP/1.0\" 502 2662 \"http://git.xxxxx.cn/\" \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.95 Safari/537.36\"\n```\n\n## å‚è€ƒèµ„æ–™\n\n- [gitlab/gitlab-ce](https://packages.gitlab.com/gitlab/gitlab-ce)\n- [å®˜ç½‘ä¸‹è½½](https://www.gitlab.cc/downloads)\n- [å®˜ç½‘å®‰è£…è¯´æ˜](https://doc.gitlab.cc/ce/install/requirements.html)\n- [å¼€æºç‰ˆæœ¬å’Œä¼ä¸šç‰ˆæœ¬å¯¹æ¯”](https://www.gitlab.cc/features/#enterprise)\n- [å®˜æ–¹å‡çº§Gitlabæ•™ç¨‹](https://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/update/8.14-to-8.15.md)\n- [å®˜æ–¹Centoså®‰è£…Gitlabæ•™ç¨‹](https://gitlab.com/gitlab-org/gitlab-recipes/tree/master/install/centos)\n- [Gitlabå‡çº§è®°å½•](http://opjasee.com/2016/01/28/gitlab-upgrade.html)\n- [ä¿®æ”¹gitlabä½¿ç”¨ç°æœ‰nginxæœåŠ¡åŠ502é—®é¢˜è§£å†³](http://www.yuzhewo.com/2015/11/03/%E4%BF%AE%E6%94%B9gitlab%E4%BD%BF%E7%94%A8%E7%8E%B0%E6%9C%89nginx%E6%9C%8D%E5%8A%A1%E5%8F%8A502%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/)\n- [æˆ‘æ‰€é‡åˆ°çš„GitLab 502é—®é¢˜çš„è§£å†³](http://blog.csdn.net/wangxicoding/article/details/43738137)"}}]);